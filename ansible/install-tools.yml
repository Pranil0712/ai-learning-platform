---
- name: Install DevOps Tools on EC2 (Ubuntu 24.04)
  hosts: devops
  become: yes

  tasks:

    # =====================================
    # SYSTEM PREPARATION
    # =====================================
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Upgrade system packages
      apt:
        upgrade: dist

    - name: Install base dependencies
      apt:
        name:
          - curl
          - ca-certificates
          - gnupg
          - lsb-release
        state: present

    # =====================================
    # DOCKER INSTALLATION
    # =====================================
    - name: Install Docker
      apt:
        name: docker.io
        state: present

    - name: Enable and start Docker
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # =====================================
    # JENKINS (DOCKER-BASED - STABLE)
    # =====================================
    - name: Pull Jenkins LTS Docker image
      shell: docker pull jenkins/jenkins:lts
      args:
        warn: false

    - name: Create Jenkins volume
      shell: docker volume create jenkins_home
      args:
        warn: false

    - name: Run Jenkins container
      shell: |
        docker run -d \
          --name jenkins \
          -p 8080:8080 \
          -p 50000:50000 \
          -v jenkins_home:/var/jenkins_home \
          --restart unless-stopped \
          jenkins/jenkins:lts
      args:
        warn: false
      ignore_errors: yes

    # =====================================
    # K3S (LIGHTWEIGHT KUBERNETES)
    # =====================================
    - name: Install K3s
      shell: curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for K3s to be ready
      shell: kubectl get nodes
      register: k3s_status
      retries: 6
      delay: 10
      until: k3s_status.rc == 0

    - name: Configure kubectl for ubuntu user
      shell: |
        mkdir -p /home/ubuntu/.kube
        cp /etc/rancher/k3s/k3s.yaml /home/ubuntu/.kube/config
        chown -R ubuntu:ubuntu /home/ubuntu/.kube
        chmod 600 /home/ubuntu/.kube/config
      args:
        creates: /home/ubuntu/.kube/config

    # =====================================
    # HELM INSTALLATION
    # =====================================
    - name: Download Helm installation script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0755'

    - name: Install Helm
      shell: /tmp/get_helm.sh
      args:
        creates: /usr/local/bin/helm