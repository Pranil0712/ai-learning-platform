---
- name: Install DevOps Tools on EC2
  hosts: devops
  become: yes

  tasks:
    - name: Update OS
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install Docker
      apt:
        name: docker.io
        state: present

    - name: Start Docker
      service:
        name: docker
        state: started
        enabled: true

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Install Dependencies for Jenkins
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Install Java 21 (Latest Jenkins Requirement)
      apt:
        name: openjdk-21-jdk
        state: present

    - name: Clean up existing Jenkins artifacts
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/jenkins.list
        - /usr/share/keyrings/jenkins-keyring.gpg

    - name: Force import Jenkins key into global trust store
      shell: |
        curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key | apt-key add -
      # Note: apt-key is technically deprecated, but it's the most reliable way to fix this specific loop.

    - name: Create Jenkins source list (Standard format)
      copy:
        dest: /etc/apt/sources.list.d/jenkins.list
        content: "deb https://pkg.jenkins.io/debian-stable binary/"

    - name: Update apt cache (The Moment of Truth)
      apt:
        update_cache: yes

    - name: Add Jenkins Repository Key
      get_url:
        url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
        dest: /usr/share/keyrings/jenkins-keyring.asc
        mode: '0644'

    - name: Add Jenkins Repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/"
        state: present
        update_cache: yes

    - name: Install Jenkins
      apt:
        name: jenkins
        state: present
        update_cache: yes

    - name: Start Jenkins
      service:
        name: jenkins
        state: started
        enabled: true

    - name: Install K3s (Kubernetes)
      shell: curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Configure kubectl for ubuntu user
      shell: |
        mkdir -p /home/ubuntu/.kube
        cp /etc/rancher/k3s/k3s.yaml /home/ubuntu/.kube/config
        chown -R ubuntu:ubuntu /home/ubuntu/.kube
        chmod 600 /home/ubuntu/.kube/config
      args:
        creates: /home/ubuntu/.kube/config

    - name: Install Helm
      shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm