---
- name: Install DevOps Tools on EC2
  hosts: devops
  become: yes

  tasks:
    # ---------------------------
    # JENKINS DEPENDENCIES (needed for key conversion)
    # ---------------------------
    - name: Install Dependencies for Jenkins
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes      # safe first update using default repositories

    # ---------------------------
    # JENKINS REPOSITORY (fixed key handling)
    # ---------------------------
    - name: Download Jenkins key (ASCII armored)
      get_url:
        url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
        dest: /tmp/jenkins-key.asc
        mode: '0644'

    - name: Convert Jenkins key to binary keyring
      command: gpg --dearmor -o /usr/share/keyrings/jenkins-keyring.gpg /tmp/jenkins-key.asc
      args:
        creates: /usr/share/keyrings/jenkins-keyring.gpg

    - name: Add Jenkins repository (with signed-by)
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/jenkins-keyring.gpg] https://pkg.jenkins.io/debian-stable binary/"
        state: present
        filename: jenkins

    # ---------------------------
    # SYSTEM UPDATE (now includes Jenkins repo with valid key)
    # ---------------------------
    - name: Update OS
      apt:
        update_cache: yes
        upgrade: dist

    # ---------------------------
    # DOCKER
    # ---------------------------
    - name: Install Docker
      apt:
        name: docker.io
        state: present

    - name: Start Docker
      service:
        name: docker
        state: started
        enabled: true

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # ---------------------------
    # JENKINS (continued)
    # ---------------------------
    - name: Install Java 21 (Latest Jenkins Requirement)
      apt:
        name: openjdk-21-jdk
        state: present

    - name: Install Jenkins
      apt:
        name: jenkins
        state: present

    - name: Start Jenkins
      service:
        name: jenkins
        state: started
        enabled: true

    # ---------------------------
    # K3S (Kubernetes)
    # ---------------------------
    - name: Install K3s (Kubernetes)
      shell: curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for K3s to be ready
      shell: kubectl get nodes
      register: k3s_status
      retries: 5
      delay: 10
      until: k3s_status.rc == 0

    - name: Configure kubectl for ubuntu user
      shell: |
        mkdir -p /home/ubuntu/.kube
        cp /etc/rancher/k3s/k3s.yaml /home/ubuntu/.kube/config
        chown -R ubuntu:ubuntu /home/ubuntu/.kube
        chmod 600 /home/ubuntu/.kube/config
      args:
        creates: /home/ubuntu/.kube/config

    # ---------------------------
    # HELM
    # ---------------------------
    - name: Download Helm install script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0755'

    - name: Install Helm
      shell: /tmp/get_helm.sh
      args:
        creates: /usr/local/bin/helm